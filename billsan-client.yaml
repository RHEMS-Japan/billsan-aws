Mappings:
  DataExports:
    CUR2:
      DefaultQuery: SELECT bill_bill_type, bill_billing_entity,
        bill_billing_period_end_date, bill_billing_period_start_date,
        bill_invoice_id, bill_invoicing_entity, bill_payer_account_id,
        bill_payer_account_name, cost_category, discount,
        discount_bundled_discount, discount_total_discount,
        identity_line_item_id, identity_time_interval,
        line_item_availability_zone, line_item_blended_cost,
        line_item_blended_rate, line_item_currency_code, line_item_legal_entity,
        line_item_line_item_description, line_item_line_item_type,
        line_item_net_unblended_cost, line_item_net_unblended_rate,
        line_item_normalization_factor, line_item_normalized_usage_amount,
        line_item_operation, line_item_product_code, line_item_resource_id,
        line_item_tax_type, line_item_unblended_cost, line_item_unblended_rate,
        line_item_usage_account_id, line_item_usage_account_name,
        line_item_usage_amount, line_item_usage_end_date,
        line_item_usage_start_date, line_item_usage_type, pricing_currency,
        pricing_lease_contract_length, pricing_offering_class,
        pricing_public_on_demand_cost, pricing_public_on_demand_rate,
        pricing_purchase_option, pricing_rate_code, pricing_rate_id,
        pricing_term, pricing_unit, product, product_comment, product_fee_code,
        product_fee_description, product_from_location,
        product_from_location_type, product_from_region_code,
        product_instance_family, product_instance_type, product_instancesku,
        product_location, product_location_type, product_operation,
        product_pricing_unit, product_product_family, product_region_code,
        product_servicecode, product_sku, product_to_location,
        product_to_location_type, product_to_region_code, product_usagetype,
        reservation_amortized_upfront_cost_for_usage,
        reservation_amortized_upfront_fee_for_billing_period,
        reservation_availability_zone, reservation_effective_cost,
        reservation_end_time, reservation_modification_status,
        reservation_net_amortized_upfront_cost_for_usage,
        reservation_net_amortized_upfront_fee_for_billing_period,
        reservation_net_effective_cost, reservation_net_recurring_fee_for_usage,
        reservation_net_unused_amortized_upfront_fee_for_billing_period,
        reservation_net_unused_recurring_fee, reservation_net_upfront_value,
        reservation_normalized_units_per_reservation,
        reservation_number_of_reservations, reservation_recurring_fee_for_usage,
        reservation_reservation_a_r_n, reservation_start_time,
        reservation_subscription_id,
        reservation_total_reserved_normalized_units,
        reservation_total_reserved_units, reservation_units_per_reservation,
        reservation_unused_amortized_upfront_fee_for_billing_period,
        reservation_unused_normalized_unit_quantity,
        reservation_unused_quantity, reservation_unused_recurring_fee,
        reservation_upfront_value, resource_tags,
        savings_plan_amortized_upfront_commitment_for_billing_period,
        savings_plan_end_time, savings_plan_instance_type_family,
        savings_plan_net_amortized_upfront_commitment_for_billing_period,
        savings_plan_net_recurring_commitment_for_billing_period,
        savings_plan_net_savings_plan_effective_cost,
        savings_plan_offering_type, savings_plan_payment_option,
        savings_plan_purchase_term,
        savings_plan_recurring_commitment_for_billing_period,
        savings_plan_region, savings_plan_savings_plan_a_r_n,
        savings_plan_savings_plan_effective_cost,
        savings_plan_savings_plan_rate, savings_plan_start_time,
        savings_plan_total_commitment_to_date, savings_plan_used_commitment FROM
        COST_AND_USAGE_REPORT
    Focus:
      DefaultQuery: SELECT AvailabilityZone, BilledCost, BillingAccountId,
        BillingAccountName, BillingCurrency, BillingPeriodEnd,
        BillingPeriodStart, ChargeCategory, ChargeClass, ChargeDescription,
        ChargeFrequency, ChargePeriodEnd, ChargePeriodStart,
        CommitmentDiscountCategory, CommitmentDiscountId,
        CommitmentDiscountName, CommitmentDiscountStatus,
        CommitmentDiscountType, ConsumedQuantity, ConsumedUnit, ContractedCost,
        ContractedUnitPrice, EffectiveCost, InvoiceIssuerName, ListCost,
        ListUnitPrice, PricingCategory, PricingQuantity, PricingUnit,
        ProviderName, PublisherName, RegionId, RegionName, ResourceId,
        ResourceName, ResourceType, ServiceCategory, ServiceName, SkuId,
        SkuPriceId, SubAccountId, SubAccountName, Tags, x_CostCategories,
        x_Discounts, x_Operation, x_ServiceCode, x_UsageType FROM FOCUS_1_0_AWS


Resources:

  #1: S3 Bucket to save all billing data export data
  DataExportBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub billsan-aws-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  #2  #1 S3 Bucket Policy for allow data export
  S3BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref DataExportBucket
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AllowBillingDataExport
            Effect: Allow
            Principal:
              Service:
                - billingreports.amazonaws.com
                - bcm-data-exports.amazonaws.com
            Action:
              - s3:PutObject
              - s3:GetBucketPolicy
            Resource:
              - !Sub arn:aws:s3:::${DataExportBucket}
              - !Sub arn:aws:s3:::${DataExportBucket}/*
            Condition:
              StringLike:
                aws:SourceArn:
                  - !Sub arn:aws:bcm-data-exports:${AWS::Region}:${AWS::AccountId}:export/*
          - Sid: AllowFromExternalAccount
            Effect: Allow
            Principal:
              AWS:
                - arn:aws:iam::063150541913:role/RHEMS-Google-Workspace-admin
                - arn:aws:iam::063150541913:role/RHEMS-Google-Workspace-readonly
                - arn:aws:iam::063150541913:role/BillSan
            Action:
              - s3:GetBucketLocation
              - s3:GetObject
              - s3:ListBucket
              - s3:ListBucketMultipartUploads
              - s3:ListMultipartUploadParts
              - s3:AbortMultipartUpload
            Resource:
              - !Sub arn:aws:s3:::${DataExportBucket}
              - !Sub arn:aws:s3:::${DataExportBucket}/*

  ####################################
  ### FocAthenaGlueAccessRoleAthenaGlueAccessRoleus
  ####################################
  #3 Deploy Data Export for Focus parquet
  BillingDataExportFocusParquet:
    Type: AWS::BCMDataExports::Export
    DependsOn: S3BucketPolicy
    Properties:
      Export:
        Name: !Sub billsan-aws-${AWS::AccountId}-focus-parquet
        RefreshCadence:
          Frequency: SYNCHRONOUS
        DataQuery:
          QueryStatement: !FindInMap
            - DataExports
            - Focus
            - DefaultQuery
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !Ref DataExportBucket
            S3Region: !Sub ${AWS::Region}
            S3Prefix: focus/parquet
            S3OutputConfigurations:
              Compression: PARQUET
              Format: PARQUET
              OutputType: CUSTOM
              Overwrite: OVERWRITE_REPORT
  #4 Deploy Data Export for Focus CSV
  BillingDataExportFocusCSV:
    Type: AWS::BCMDataExports::Export
    Properties:
      Export:
        Name: !Sub billsan-aws-${AWS::AccountId}-focus-csv
        RefreshCadence:
          Frequency: SYNCHRONOUS
        DataQuery:
          QueryStatement: !FindInMap
            - DataExports
            - Focus
            - DefaultQuery
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !Ref DataExportBucket
            S3Region: !Sub ${AWS::Region}
            S3Prefix: focus/csv
            S3OutputConfigurations:
              Compression: GZIP
              Format: TEXT_OR_CSV
              OutputType: CUSTOM
              Overwrite: OVERWRITE_REPORT
    DependsOn: S3BucketPolicy


  ####################################
  ### CUR 2.0
  ####################################
  #5 Deploy Data Export for CUR 2.0 parquet
  BillingDataExportCUR2Parquet:
    Type: AWS::BCMDataExports::Export
    DependsOn: S3BucketPolicy
    Properties:
      Export:
        DataQuery:
          QueryStatement: !FindInMap
            - DataExports
            - CUR2
            - DefaultQuery
          TableConfigurations:
            COST_AND_USAGE_REPORT:
              TIME_GRANULARITY: HOURLY
              INCLUDE_RESOURCES: 'TRUE'
              INCLUDE_MANUAL_DISCOUNT_COMPATIBILITY: 'FALSE'
              INCLUDE_SPLIT_COST_ALLOCATION_DATA: 'FALSE'
        Description: CUR 2.0 export for aggregation in CID
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !Ref DataExportBucket
            S3Region: !Sub ${AWS::Region}
            S3Prefix: cur2.0/parquet
            S3OutputConfigurations:
              Overwrite: OVERWRITE_REPORT
              Format: PARQUET
              Compression: PARQUET
              OutputType: CUSTOM
        Name: !Sub billsan-aws-${AWS::AccountId}-cur2-parquet
        RefreshCadence:
          Frequency: SYNCHRONOUS
  #6 Deploy Data Export for CUR 2.0 CSV
  BillingDataExportCUR2CSV:
    Type: AWS::BCMDataExports::Export
    DependsOn: S3BucketPolicy
    Properties:
      Export:
        DataQuery:
          QueryStatement: !FindInMap
            - DataExports
            - CUR2
            - DefaultQuery
          TableConfigurations:
            COST_AND_USAGE_REPORT:
              TIME_GRANULARITY: HOURLY
              INCLUDE_RESOURCES: 'TRUE'
              INCLUDE_MANUAL_DISCOUNT_COMPATIBILITY: 'FALSE'
              INCLUDE_SPLIT_COST_ALLOCATION_DATA: 'FALSE'
        Description: CUR 2.0 export for aggregation in CID
        DestinationConfigurations:
          S3Destination:
            S3Bucket: !Ref DataExportBucket
            S3Region: !Sub ${AWS::Region}
            S3Prefix: cur2.0/csv
            S3OutputConfigurations:
              Overwrite: OVERWRITE_REPORT
              Format: TEXT_OR_CSV
              Compression: GZIP
              OutputType: CUSTOM
        Name: !Sub billsan-aws-${AWS::AccountId}-cur2-csv
        RefreshCadence:
          Frequency: SYNCHRONOUS
